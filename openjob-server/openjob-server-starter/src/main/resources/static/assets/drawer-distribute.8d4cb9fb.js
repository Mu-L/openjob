import{_ as O}from"./preload-helper.101896b7.js";import{h as E,ap as q,r as C,K as G,a9 as u,ac as Q,j as x,k as W,D as o,x as n,l as v,C as d,u as i,B as m,y as j,v as X,E as z,F as Y}from"./vue.bd0669ce.js";import{u as Z}from"./vue-i18n.cjs.2a00fe88.js";import{f as D,b as f}from"./data.65169b13.js";import{u as ee}from"./index.85cc70c8.js";import{a as _}from"./formatTime.b2c6dda0.js";import{J as ae}from"./index.f64fca3a.js";import{ay as se}from"./index.e8f4f9cf.js";import"./_commonjsHelpers.35101cd5.js";import"./index.510ba4c9.js";import"./request.c46845dc.js";import"./storage.b628b270.js";import"./index.d2f052aa.js";import"./index.aa7cec2e.js";import"./themeConfig.cb88f033.js";import"./header.9390c1c5.js";import"./index.ee56f1f7.js";const te=E({name:"jobDrawerName"}),je=E({...te,setup(oe,{expose:L}){const{t}=Z(),S=q(()=>O(()=>import("./drawer-detail.50d0ae2f.js"),["assets/drawer-detail.50d0ae2f.js","assets/preload-helper.101896b7.js","assets/vue.bd0669ce.js","assets/vue-i18n.cjs.2a00fe88.js","assets/_commonjsHelpers.35101cd5.js","assets/index.85cc70c8.js","assets/request.c46845dc.js","assets/storage.b628b270.js","assets/index.d2f052aa.js","assets/index.aa7cec2e.js","assets/themeConfig.cb88f033.js","assets/index.f64fca3a.js","assets/index.e8f4f9cf.js","assets/index.ee56f1f7.js"])),y=C(),I=ee(),b=C(new Map),e=G({tabsValue:"base",pageShow:!1,tabListTitle:"",drawer:{isShow:!1},pagination:{page:1,size:20,total:0},descriptions:{column:8,jobName:"",workerAddress:"",createTime:"",executeType:"",timeExpressionType:"",completeTime:"",statusTag:"",statusLabel:"Default"},table:{loading:!1},jobInstanceId:0,timeExpressionType:"",taskList:[]}),V=async a=>{e.descriptions.jobName=a.jobName,e.descriptions.workerAddress=a.workerAddress,e.descriptions.createTime=a.createTime,e.descriptions.completeTime=a.completeTime,e.descriptions.executeType=a.executeType,e.descriptions.timeExpressionType=a.timeExpressionType,e.descriptions.statusTag=D(a.status).tag,e.descriptions.statusLabel=D(a.status).label,e.jobInstanceId=a.id,e.timeExpressionType=a.timeExpressionType,e.tabsValue="base",e.pageShow=!1,e.taskList=[],e.drawer.isShow=!0,a.executeType=="sharding"?e.tabListTitle=t("message.job.task.shardingTasks"):a.executeType=="broadcast"?e.tabListTitle=t("message.job.task.broadcastTasks"):e.tabListTitle=t("message.job.task.tasks")},N=async a=>{e.pagination.size=a,await g()},A=async a=>{e.pagination.page=a,await g()},B=async a=>{if(a=="list"){e.pagination.page=1,e.pagination.size=20,await g(),e.pageShow=!0;return}e.pageShow=!1},g=async()=>{e.table.loading=!0;let a=await I.getListTaskList({jobInstanceId:e.jobInstanceId,timeExpressionType:e.timeExpressionType,page:e.pagination.page,size:e.pagination.size});e.taskList=[],e.pagination.page=a.page,e.pagination.size=a.size,e.pagination.total=a.total,a.list.forEach(function(s){let p=s.taskName;e.timeExpressionType=="secondDelay"&&(p=t("message.job.task.name1")+s.circleId+t("message.job.task.name2")),e.taskList.push({id:s.id,jobId:s.jobId,jobInstanceId:s.jobInstanceId,circleId:s.circleId,taskId:s.taskId,parentTaskId:s.parentTaskId,dispatchVersion:s.dispatchVersion,workerAddress:s.workerAddress,taskName:p,status:s.status,taskStatus:s.status,statusTag:f(s.status).tag,statusLabel:f(s.status).label,createTime:_(s.createTime),completeTime:_(s.updateTime),result:s.result,childCount:s.childCount,pull:s.pull,hasChildren:s.childCount>0})}),e.table.loading=!1,b.value.forEach((s,p)=>{h(s.row,s.treeNode,s.resolve)})},h=async(a,s,p)=>{b.value.set(a.taskId,{row:a,treeNode:s,resolve:p});let k=await I.getListChildList({taskId:a.taskId,jobInstanceId:a.jobInstanceId,circleId:a.circleId,pull:a.pull,page:1,size:20}),T=[];k.list.forEach(function(l){let c=l.taskName;l.childCount>0&&(c+=" ["+l.childCount+"]"),T.push({id:l.id,jobId:l.jobId,jobInstanceId:l.jobInstanceId,circleId:l.circleId,taskId:l.taskId,parentTaskId:l.parentTaskId,dispatchVersion:l.dispatchVersion,workerAddress:l.workerAddress,taskName:c,status:l.status,taskStatus:l.status,statusTag:f(l.status).tag,statusLabel:f(l.status).label,createTime:_(l.createTime),completeTime:_(l.updateTime),result:l.result,childCount:l.childCount,pull:l.pull,hasChildren:l.childCount>0})}),p(T)},M=a=>{y.value.openDrawer(a)},U=a=>{ae.confirm(t("message.job.instance.stopTitle")+`(${a.taskId})?`,t("message.commonMsg.tip"),{confirmButtonText:t("message.commonBtn.confirm"),cancelButtonText:t("message.commonBtn.cancel"),type:"warning"}).then(async()=>{await I.stop({jobInstanceId:a.jobInstanceId,dispatchVersion:a.dispatchVersion,circleId:a.circleId,taskId:a.taskId}),setTimeout(async()=>{if(b.value.has(a.parentTaskId)){let s=b.value.get(a.parentTaskId);await h(s.row,s.treeNode,s.resolve)}await g()},1e3),se.success(t("message.commonMsg.stopSuccess"))}).catch(()=>{})},$=()=>{};return L({openDrawer:V}),(a,s)=>{const p=u("el-descriptions-item"),k=u("el-tag"),T=u("el-descriptions"),l=u("el-tab-pane"),c=u("el-table-column"),w=u("el-button"),R=u("el-table"),F=u("el-tabs"),H=u("el-pagination"),P=u("el-drawer"),J=Q("loading");return x(),W(Y,null,[o(P,{modelValue:e.drawer.isShow,"onUpdate:modelValue":s[3]||(s[3]=r=>e.drawer.isShow=r),direction:"rtl",size:"76%",onClose:s[4]||(s[4]=r=>$())},{header:n(()=>[v("div",null,[v("h4",null,d(i(t)("message.job.task.title")),1)])]),default:n(()=>[o(F,{modelValue:e.tabsValue,"onUpdate:modelValue":s[0]||(s[0]=r=>e.tabsValue=r),type:"border-card",style:{"border-top":"none",height:"100%"},onTabChange:B},{default:n(()=>[o(l,{name:"base",label:i(t)("message.job.task.base")},{default:n(()=>[o(T,{column:"1",border:""},{default:n(()=>[o(p,{label:i(t)("message.job.task.taskName")},{default:n(()=>[m(d(e.descriptions.jobName),1)]),_:1},8,["label"]),o(p,{label:i(t)("message.job.task.workerAddress")},{default:n(()=>[m(d(e.descriptions.workerAddress),1)]),_:1},8,["label"]),o(p,{label:i(t)("message.job.task.status")},{default:n(()=>[o(k,{class:"ml-2",type:e.descriptions.statusTag},{default:n(()=>[m(d(e.descriptions.statusLabel),1)]),_:1},8,["type"])]),_:1},8,["label"]),o(p,{label:i(t)("message.job.job.executeType")},{default:n(()=>[m(d(e.descriptions.executeType),1)]),_:1},8,["label"]),o(p,{label:i(t)("message.job.job.timeExpressionType")},{default:n(()=>[m(d(e.descriptions.timeExpressionType),1)]),_:1},8,["label"]),o(p,{label:i(t)("message.job.task.createTime")},{default:n(()=>[m(d(e.descriptions.createTime),1)]),_:1},8,["label"]),o(p,{label:i(t)("message.job.task.completeTime")},{default:n(()=>[m(d(e.descriptions.completeTime),1)]),_:1},8,["label"])]),_:1})]),_:1},8,["label"]),o(l,{name:"list",label:e.tabListTitle},{default:n(()=>[j((x(),X(R,{data:e.taskList,style:{width:"100%"},size:"default","row-key":"taskId",lazy:"",load:h,"show-header":!0,"tree-props":{children:"children",hasChildren:"hasChildren"}},{default:n(()=>[o(c,{prop:"taskName",label:i(t)("message.job.task.taskName")},null,8,["label"]),o(c,{prop:"workerAddress",label:i(t)("message.job.task.workerAddress"),"show-overflow-tooltip":""},null,8,["label"]),o(c,{prop:"taskStatus",label:i(t)("message.job.task.status")},{default:n(r=>[o(k,{class:"ml-2",type:r.row.statusTag},{default:n(()=>[m(d(r.row.statusLabel),1)]),_:2},1032,["type"])]),_:1},8,["label"]),o(c,{prop:"createTime",label:i(t)("message.job.task.createTime")},null,8,["label"]),o(c,{prop:"completeTime",label:i(t)("message.job.task.completeTime")},null,8,["label"]),o(c,{prop:"result",label:i(t)("message.job.task.result"),"show-overflow-tooltip":""},null,8,["label"]),o(c,{fixed:"right",label:i(t)("message.job.task.operation"),width:"120"},{default:n(r=>[o(w,{link:"",type:"primary",size:"small",onClick:K=>M(r.row)},{default:n(()=>[m(d(i(t)("message.job.task.detail")),1)]),_:2},1032,["onClick"]),j(o(w,{onClick:K=>U(r.row),link:"",type:"danger",size:"small"},{default:n(()=>[m(d(i(t)("message.job.task.stop")),1)]),_:2},1032,["onClick"]),[[z,r.row.status===15]])]),_:1},8,["label"])]),_:1},8,["data"])),[[J,e.table.loading]])]),_:1},8,["label"])]),_:1},8,["modelValue"])]),footer:n(()=>[j(o(H,{"current-page":e.pagination.page,"onUpdate:current-page":s[1]||(s[1]=r=>e.pagination.page=r),"page-size":e.pagination.size,"onUpdate:page-size":s[2]||(s[2]=r=>e.pagination.size=r),"page-sizes":[20,50,100,200],background:"",layout:"total, sizes, prev, pager, next, jumper",total:e.pagination.total,onSizeChange:N,onCurrentChange:A,style:{"margin-left":"12px","padding-bottom":"12px"}},null,8,["current-page","page-size","total"]),[[z,e.pageShow]])]),_:1},8,["modelValue"]),o(i(S),{ref_key:"DetailDrawerRef",ref:y},null,512)],64)}}});export{je as default};
